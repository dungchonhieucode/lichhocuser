<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lịch học, việc cần làm (có quản lý user & phân quyền)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.tailwindcss.com">

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

  <style>
    :root {
      --bg-primary: #f9fafb;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f3f4f6;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --border-color: #d1d5db;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    [data-theme="dark"] {
      --bg-primary: #111827;
      --bg-secondary: #1f2937;
      --bg-tertiary: #374151;
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --border-color: #4b5563;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
    }

    * {
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    body { 
      font-family: 'Inter', sans-serif; 
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }

    .app-bg { background-color: var(--bg-primary); }
    .card-bg { background-color: var(--bg-secondary); }
    .surface-bg { background-color: var(--bg-tertiary); }
    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .border-custom { border-color: var(--border-color); }
    .shadow-custom { box-shadow: var(--shadow); }
    .shadow-lg-custom { box-shadow: var(--shadow-lg); }

    .day-card { 
      border-radius: 16px; 
      min-height: 160px; 
      transition: transform .12s, box-shadow .12s, background-color 0.2s ease; 
      padding: 1rem;
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
    }

    .day-card.drag-over { 
      box-shadow: 0 0 0 4px rgba(91,33,182,0.25); 
      transform: scale(1.02); 
    }

    .task-item { 
      border-radius: 12px; 
      padding: 0.5rem; 
      margin-top: .5rem; 
      color: #1f2937; 
      cursor: grab; 
      user-select: none; 
      font-weight: 500;
      transition: all 0.2s ease;
      position: relative;
    }

    .task-item:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .task-item.dragging { 
      opacity: .6; 
      transform: rotate(5deg);
      z-index: 1000;
    }

    .task-item .drag-handle {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0;
      transition: opacity 0.2s ease;
      cursor: grab;
      color: rgba(255,255,255,0.7);
      font-size: 12px;
    }

    .task-item:hover .drag-handle {
      opacity: 1;
    }

    .task-container {
      min-height: 20px;
    }

    .task-container.drag-over-container {
      background-color: rgba(91,33,182,0.1);
      border-radius: 8px;
    }

    #sidebar { 
      z-index: 60; 
      right: 0; 
      top: 0;
      background-color: var(--bg-secondary);
      box-shadow: var(--shadow-lg);
      border-left: 1px solid var(--border-color);
    }

    #current-week-display { 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis; 
    }

    .modal-bg {
      background-color: var(--bg-secondary);
      box-shadow: var(--shadow-lg);
    }

    .input-custom {
      background-color: var(--bg-secondary);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    .input-custom:focus {
      outline: none;
      ring: 2px;
      ring-color: #8b5cf6;
    }

    .btn-hover:hover {
      filter: brightness(0.9);
    }

    .spinner {
      border: 2px solid var(--border-color);
      border-top: 2px solid #8b5cf6;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    [data-theme="dark"] .day-pink { background-color: #4c1d95; }
    [data-theme="dark"] .day-purple { background-color: #581c87; }
    [data-theme="dark"] .day-blue { background-color: #1e3a8a; }
    [data-theme="dark"] .day-green { background-color: #14532d; }
    [data-theme="dark"] .day-yellow { background-color: #92400e; }
    [data-theme="dark"] .day-stone { background-color: #44403c; }
    [data-theme="dark"] .day-gray { background-color: #374151; }

    .day-pink { background-color: #fce7f3; }
    .day-purple { background-color: #f3e8ff; }
    .day-blue { background-color: #dbeafe; }
    .day-green { background-color: #dcfce7; }
    .day-yellow { background-color: #fef3c7; }
    .day-stone { background-color: #f5f5f4; }
    .day-gray { background-color: #f3f4f6; }
  </style>

  <script>
    // Theme detection and application (before DOM load for no flash)
    (function() {
      const savedTheme = localStorage.getItem('theme') || 
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', savedTheme);
    })();
  </script>
</head>
<body class="p-4 app-bg text-primary">

<div class="container mx-auto max-w-4xl">
  <!-- Header -->
  <header class="flex justify-between items-center py-2 px-4">
    <h1 class="text-xl sm:text-2xl font-bold text-primary">Lịch học</h1>
    <div class="flex items-center gap-3">
      <div id="sync-indicator" class="flex items-center gap-2">
        <span id="sync-dot" class="inline-block w-3 h-3 rounded-full bg-gray-400"></span>
        <div id="loading-spinner" class="spinner hidden"></div>
      </div>
      <div id="user-area" class="flex items-center gap-3">
        <span id="user-email-display" class="text-sm text-secondary hidden"></span>
        <button id="auth-open-btn" class="px-2 py-1 rounded bg-indigo-500 text-white text-sm">Đăng nhập</button>
        <button id="logout-btn" class="px-2 py-1 rounded bg-red-500 text-white text-sm hidden">Đăng xuất</button>
      </div>
      <button id="menu-toggle" class="text-secondary p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </header>

  <!-- Navigation -->
  <div class="flex items-center p-2 gap-2">
    <button id="prev-week-btn" class="px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm btn-hover transition-all">
      <i class="fas fa-arrow-left"></i>
    </button>

    <div class="text-center flex-1 px-2">
      <h2 id="current-week-display" class="text-sm font-semibold text-primary"></h2>
      <div class="text-xs text-blue-500 mt-1 hidden sm:block">
        <button id="copy-last-week-btn-inline" class="underline hover:text-blue-700 transition-colors">Sao chép lịch từ tuần trước</button>
      </div>
    </div>

    <button id="next-week-btn" class="px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm btn-hover transition-all">
      <i class="fas fa-arrow-right"></i>
    </button>
  </div>

  <!-- Week view -->
  <div id="week-view" class="grid grid-cols-2 lg:grid-cols-3 gap-3 p-4">
    <div id="T2" class="day-card day-pink"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-primary">T2</h3><button onclick="openAddTaskModal('T2')" class="text-xl hover:bg-pink-200 dark:hover:bg-pink-800 rounded px-2 transition-colors text-primary add-btn">+</button></div><div id="tasks-T2" class="task-container"></div></div>
    <div id="T3" class="day-card day-purple"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-primary">T3</h3><button onclick="openAddTaskModal('T3')" class="text-xl hover:bg-purple-200 dark:hover:bg-purple-800 rounded px-2 transition-colors text-primary add-btn">+</button></div><div id="tasks-T3" class="task-container"></div></div>
    <div id="T4" class="day-card day-blue"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-primary">T4</h3><button onclick="openAddTaskModal('T4')" class="text-xl hover:bg-blue-200 dark:hover:bg-blue-800 rounded px-2 transition-colors text-primary add-btn">+</button></div><div id="tasks-T4" class="task-container"></div></div>
    <div id="T5" class="day-card day-green"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-primary">T5</h3><button onclick="openAddTaskModal('T5')" class="text-xl hover:bg-green-200 dark:hover:bg-green-800 rounded px-2 transition-colors text-primary add-btn">+</button></div><div id="tasks-T5" class="task-container"></div></div>
    <div id="T6" class="day-card day-yellow"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-primary">T6</h3><button onclick="openAddTaskModal('T6')" class="text-xl hover:bg-yellow-200 dark:hover:bg-yellow-800 rounded px-2 transition-colors text-primary add-btn">+</button></div><div id="tasks-T6" class="task-container"></div></div>
    <div id="T7" class="day-card day-stone"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-primary">T7</h3><button onclick="openAddTaskModal('T7')" class="text-xl hover:bg-stone-200 dark:hover:bg-stone-800 rounded px-2 transition-colors text-primary add-btn">+</button></div><div id="tasks-T7" class="task-container"></div></div>
    <div id="CN" class="day-card day-gray"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-primary">CN</h3><button onclick="openAddTaskModal('CN')" class="text-xl hover:bg-gray-300 dark:hover:bg-gray-600 rounded px-2 transition-colors text-primary add-btn">+</button></div><div id="tasks-CN" class="task-container"></div></div>
  </div>
</div>

<!-- Sidebar -->
<div id="sidebar" class="fixed top-0 right-0 w-96 h-full card-bg shadow-lg-custom border-custom transform translate-x-full transition-transform duration-300 ease-in-out">
  <div class="p-4 space-y-4">
    <div class="flex justify-between items-center">
      <h3 class="font-semibold text-lg text-primary">Tùy chọn</h3>
      <button id="sidebar-close" class="text-secondary p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Theme Toggle -->
    <button id="theme-toggle-btn" class="w-full flex items-center gap-2 px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg transition-colors btn-hover">
      <i id="theme-icon" class="fas fa-moon"></i>
      <span id="theme-text">Chế độ tối</span>
    </button>

    <button id="copy-last-week-btn" class="w-full flex items-center gap-2 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors btn-hover">
      <i class="fas fa-copy"></i>
      <span>Sao chép tuần trước</span>
    </button>

    <!-- Removed toggle-view-btn (loại bỏ chuyển xem tháng) -->

    <button id="delete-all-week-btn" class="w-full flex items-center gap-2 px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors btn-hover">
      <i class="fas fa-trash-alt"></i>
      <span>Xóa tất cả tuần này</span>
    </button>

    <hr/>

    <!-- Admin user management (chỉ hiển thị nếu user là admin) -->
    <div id="admin-users-section" class="hidden">
      <h4 class="font-semibold text-sm mb-2">Quản lý user (Admin)</h4>

      <!-- Create user record form -->
      <div class="p-2 border rounded mb-2">
        <div class="text-xs text-secondary mb-1">Tạo record user mới (không tạo tài khoản Auth)</div>
        <input id="new-user-email" placeholder="Email (vd: abc@domain.com)" class="w-full border rounded p-2 mb-2 input-custom border-custom text-sm"/>
        <select id="new-user-role" class="w-full border rounded p-2 mb-2 input-custom border-custom text-sm">
          <option value="viewer">viewer</option>
          <option value="editor">editor</option>
          <option value="admin">admin</option>
        </select>
        <div class="flex gap-2">
          <button id="create-user-record-btn" class="flex-1 px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded text-sm">Tạo user record</button>
          <button id="invite-user-btn" class="flex-1 px-3 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded text-sm">Tạo và đánh dấu invite</button>
        </div>
        <div class="text-xs text-secondary mt-2">Ghi chú: chức năng client không thể tạo tài khoản Auth cho người khác; để tạo Auth cần làm qua backend hoặc yêu cầu user đăng ký.</div>
      </div>

      <div id="users-list" class="space-y-2 max-h-64 overflow-auto"></div>
      <div class="mt-2">
        <button id="refresh-users-btn" class="w-full px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">Làm mới danh sách</button>
      </div>
    </div>

  </div>
</div>

<!-- Modal: task -->
<div id="task-modal" class="fixed inset-0 bg-gray-800 bg-opacity-40 flex items-center justify-center p-4 hidden z-50">
  <div class="modal-bg p-5 rounded-xl w-full max-w-sm shadow-lg-custom">
    <h2 id="modal-title" class="text-lg font-semibold mb-3 text-primary">Thêm môn học</h2>
    <input id="task-text" class="w-full border rounded p-2 mb-2 input-custom border-custom" placeholder="Nội dung môn / việc"/>
    <div class="flex gap-2 mb-2">
      <select id="task-day" class="flex-1 border rounded p-2 input-custom border-custom">
        <option value="T2">Thứ 2</option><option value="T3">Thứ 3</option><option value="T4">Thứ 4</option>
        <option value="T5">Thứ 5</option><option value="T6">Thứ 6</option><option value="T7">Thứ 7</option>
        <option value="CN">Chủ Nhật</option>
      </select>
      <input id="task-color" type="color" class="w-14 p-0 rounded border border-custom" value="#e85499"/>
    </div>
    <input id="task-date" type="date" class="hidden"/>
    <div id="task-last-updated" class="text-xs text-secondary mb-2"></div>
    <div class="flex justify-end gap-2">
      <button id="delete-task-btn" onclick="deleteTask()" class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded hidden transition-colors btn-hover">Xóa</button>
      <button onclick="closeModal()" class="px-3 py-2 surface-bg hover:bg-gray-300 dark:hover:bg-gray-600 rounded transition-colors text-primary">Hủy</button>
      <button id="save-task-btn" onclick="saveTask()" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded transition-colors btn-hover">Lưu</button>
    </div>
  </div>
</div>

<!-- Modal: auth (Đăng nhập / Đăng ký) -->
<div id="auth-modal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="modal-bg p-5 rounded-xl w-full max-w-sm shadow-lg-custom">
    <h2 id="auth-title" class="text-lg font-semibold mb-3 text-primary">Đăng nhập</h2>
    <input id="auth-email" type="email" class="w-full border rounded p-2 mb-2 input-custom border-custom" placeholder="Email" />
    <input id="auth-password" type="password" class="w-full border rounded p-2 mb-2 input-custom border-custom" placeholder="Mật khẩu (>=6 ký tự)" />
    <div class="text-sm text-secondary mb-3" id="auth-note">Bạn có thể đăng ký tài khoản mới nếu chưa có.</div>
    <div class="flex gap-2 justify-end">
      <button id="toggle-auth-mode" class="px-3 py-2 rounded bg-gray-200">Đăng ký</button>
      <button id="auth-submit" class="px-3 py-2 rounded bg-indigo-600 text-white">Đăng nhập</button>
    </div>
  </div>
</div>

<script type="module">
  // Firebase imports (app + firestore + auth)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, where, writeBatch, getDocs, getDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  // Firebase config - giữ nguyên nếu bạn dùng project hiện tại
  const firebaseConfig = {
    apiKey: "AIzaSyDUQpOlvgn1TwT8TkfdHyesl1bc3Qbn0pM",
    authDomain: "dulieulichhoc.firebaseapp.com",
    projectId: "dulieulichhoc",
    storageBucket: "dulieulichhoc.firebasestorage.app",
    messagingSenderId: "46236518897",
    appId: "1:46236518897:web:8a6692006e802902965c50"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const appId = firebaseConfig.projectId;
  const tasksCollectionRef = collection(db, "artifacts", appId, "public", "data", "tasks");
  const usersCollectionRef = collection(db, "users");

  // Helpers
  const debounce = (func, wait) => {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  };
  const throttle = (func, limit) => {
    let inThrottle;
    return function() {
      const args = arguments;
      const context = this;
      if (!inThrottle) {
        func.apply(context, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    }
  };

  // State
  let currentEditingTask = null;
  let currentDate = new Date();
  let draggedElement = null;
  let currentTheme = localStorage.getItem('theme') || 'light';
  let tasksCache = new Map();
  let isLoading = false;
  let currentWeekId = null;
  let currentUser = null;
  let currentRole = 'viewer';
  let unsubscribeWeek = null;

  const dayMap = { 'T2':0,'T3':1,'T4':2,'T5':3,'T6':4,'T7':5,'CN':6 };
  const dayIndexToKey = ['T2','T3','T4','T5','T6','T7','CN'];

  // THEME
  function updateTheme(theme) {
    currentTheme = theme;
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    updateThemeButton();
  }
  function updateThemeButton() {
    const themeIcon = document.getElementById('theme-icon');
    const themeText = document.getElementById('theme-text');
    if (currentTheme === 'dark') {
      themeIcon.className = 'fas fa-sun';
      themeText.textContent = 'Chế độ sáng';
    } else {
      themeIcon.className = 'fas fa-moon';
      themeText.textContent = 'Chế độ tối';
    }
  }

  // LOADING
  function setLoading(loading) {
    isLoading = loading;
    const spinner = document.getElementById('loading-spinner');
    const syncDot = document.getElementById('sync-dot');
    if (loading) {
      spinner.classList.remove('hidden');
      syncDot.style.backgroundColor = 'orange';
    } else {
      spinner.classList.add('hidden');
    }
  }

  // Helpers for dates
  function getWeekDateRange(date) {
    const start = new Date(date);
    const dayOfWeek = start.getDay();
    const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
    start.setDate(date.getDate() - diff);
    start.setHours(0,0,0,0);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    end.setHours(23,59,59,999);
    return { start, end };
  }

  function formatDate(date) {
    if (typeof date === 'string') return date;
    const y = date.getFullYear();
    const m = String(date.getMonth()+1).padStart(2,'0');
    const d = String(date.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }

  function updateDateDisplay() {
    const { start, end } = getWeekDateRange(currentDate);
    const opt = { day: '2-digit', month: '2-digit' };
    document.getElementById('current-week-display').textContent = `Tuần từ ${start.toLocaleDateString('vi-VN', opt)} đến ${end.toLocaleDateString('vi-VN', opt)}`;
  }

  // Reorder tasks in day
  async function reorderTasksInDay(day, taskElements) {
    const tasks = Array.from(taskElements).map((el, index) => ({
      id: el.dataset.taskId,
      order: index + 1
    }));

    const batch = writeBatch(db);
    tasks.forEach(task => {
      const ref = doc(db, "artifacts", appId, "public", "data", "tasks", task.id);
      batch.update(ref, { 
        order: task.order,
        updatedAt: new Date().toISOString()
      });
    });

    try {
      await batch.commit();
    } catch (err) {
      console.error("Error reordering tasks:", err);
    }
  }

  // Render tasks with cache
  const renderTasks = throttle((tasksByDay) => {
    Object.keys(tasksByDay).forEach(day => {
      const container = document.getElementById(`tasks-${day}`);
      if (!container) return;
      const fragment = document.createDocumentFragment();
      tasksByDay[day].sort((a, b) => (a.order || 0) - (b.order || 0) || (a.text || '').localeCompare(b.text || ''));
      tasksByDay[day].forEach((task, index) => {
        const cacheKey = `${task.id}-${task.updatedAt}-${task.order}`;
        let el;
        if (tasksCache.has(cacheKey)) {
          el = tasksCache.get(cacheKey);
        } else {
          el = document.createElement('div');
          el.className = 'task-item p-2 mb-1 rounded transition-all hover:shadow-md';
          el.style.backgroundColor = task.color || '#e85499';
          el.textContent = task.text || '(không tên)';
          el.setAttribute('draggable', 'true');
          const dragHandle = document.createElement('i');
          dragHandle.className = 'fas fa-grip-lines drag-handle';
          el.appendChild(dragHandle);
          tasksCache.set(cacheKey, el);
        }
        el.dataset.taskId = task.id;
        el.dataset.taskDay = task.day || '';
        el.dataset.taskDate = task.date || '';
        el.dataset.taskOrder = task.order || index;
        setupTaskEventListeners(el, task, day);
        fragment.appendChild(el);
      });
      container.innerHTML = '';
      container.appendChild(fragment);
    });
  }, 50);

  function setupTaskEventListeners(el, task, day) {
    el.addEventListener('click', (e) => { 
      if (e.target.classList.contains('drag-handle')) return;
      e.stopPropagation(); 
      openEditTaskModal(task); 
    });
    el.addEventListener('dragstart', (e) => {
      draggedElement = e.target;
      e.dataTransfer.setData('text/plain', task.id);
      e.dataTransfer.effectAllowed = 'move';
      setTimeout(() => e.target.classList.add('dragging'), 0);
    });
    el.addEventListener('dragend', (e) => {
      e.target.classList.remove('dragging');
      draggedElement = null;
      document.querySelectorAll('.drag-over-container').forEach(c => c.classList.remove('drag-over-container'));
      document.querySelectorAll('.drag-over').forEach(c => c.classList.remove('drag-over'));
    });
    el.addEventListener('dragover', (e) => {
      if (draggedElement && draggedElement !== el && draggedElement.dataset.taskDay === el.dataset.taskDay) {
        e.preventDefault();
        const container = el.parentElement;
        const afterElement = getDragAfterElement(container, e.clientY);
        if (afterElement == null) {
          container.appendChild(draggedElement);
        } else {
          container.insertBefore(draggedElement, afterElement);
        }
      }
    });
  }

  function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.task-item:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  function initDayCardDropHandlers() {
    document.querySelectorAll('.day-card').forEach(element => {
      element.addEventListener('dragover', e => e.preventDefault());
      element.addEventListener('dragenter', e => {
        e.preventDefault();
        const targetContainer = element.querySelector('.task-container');
        if (draggedElement && targetContainer && draggedElement.parentElement !== targetContainer) {
          element.classList.add('drag-over');
        }
      });
      element.addEventListener('dragleave', e => {
        element.classList.remove('drag-over');
      });
      element.addEventListener('drop', e => {
        e.preventDefault();
        if (!draggedElement) return;
        element.classList.remove('drag-over');
        const targetCard = element.closest('.day-card');
        const targetContainer = targetCard.querySelector('.task-container');
        const taskId = draggedElement.dataset.taskId;
        const originalDay = draggedElement.dataset.taskDay;
        const newDay = targetCard.id;
        if (originalDay !== newDay) {
          const afterElement = getDragAfterElement(targetContainer, e.clientY);
          if (afterElement) {
            targetContainer.insertBefore(draggedElement, afterElement);
          } else {
            targetContainer.appendChild(draggedElement);
          }
          draggedElement.dataset.taskDay = newDay;
          const { start } = getWeekDateRange(currentDate);
          const newDate = new Date(start);
          newDate.setDate(start.getDate() + dayMap[newDay]);
          const ref = doc(db, "artifacts", appId, "public", "data", "tasks", taskId);
          setDoc(ref, { 
            day: newDay, 
            date: formatDate(newDate),
            updatedAt: new Date().toISOString() 
          }, { merge: true }).catch(err => {
            console.error("Lỗi khi di chuyển task:", err);
            setupWeekListener(); 
          });
          const originalContainer = document.getElementById(`tasks-${originalDay}`);
          if (originalContainer) reorderTasksInDay(originalDay, originalContainer.querySelectorAll('.task-item'));
          reorderTasksInDay(newDay, targetContainer.querySelectorAll('.task-item'));
        } else {
          reorderTasksInDay(newDay, targetContainer.querySelectorAll('.task-item'));
        }
      });
    });
  }

  // Listen tasks for the current week
  function setupWeekListener() {
    if (unsubscribeWeek) unsubscribeWeek();
    tasksCache.clear();
    updateDateDisplay();
    setLoading(true);
    const { start, end } = getWeekDateRange(currentDate);
    const weekId = formatDate(start);
    currentWeekId = weekId;
    const q = query(tasksCollectionRef, where("date", ">=", formatDate(start)), where("date", "<=", formatDate(end)));
    unsubscribeWeek = onSnapshot(q, (snapshot) => {
      if (currentWeekId !== weekId) return;
      document.getElementById('sync-dot').style.backgroundColor = 'green';
      const tasksByDay = { T2:[], T3:[], T4:[], T5:[], T6:[], T7:[], CN:[] };
      snapshot.forEach(docSnap => {
        const d = docSnap.data();
        if (d.day && tasksByDay[d.day]) tasksByDay[d.day].push({ id: docSnap.id, ...d });
      });
      renderTasks(tasksByDay);
      setLoading(false);
    }, (err) => {
      console.error("Week listener error:", err);
      document.getElementById('sync-dot').style.backgroundColor = 'red';
      setLoading(false);
    });
  }

  async function deleteAllWeekTasks() {
    if (!confirm("Bạn có chắc chắn muốn xóa TẤT CẢ môn học trong tuần này không?\n\nHành động này KHÔNG THỂ HOÀN TÁC!")) return;
    setLoading(true);
    const { start, end } = getWeekDateRange(currentDate);
    const q = query(tasksCollectionRef, where("date", ">=", formatDate(start)), where("date", "<=", formatDate(end)));
    try {
      const snapshot = await getDocs(q);
      if (snapshot.empty) {
        alert("Không có môn học nào trong tuần này để xóa!");
        setLoading(false);
        return;
      }
      const batch = writeBatch(db);
      snapshot.forEach(docSnap => batch.delete(docSnap.ref));
      await batch.commit();
      alert(`Đã xóa thành công ${snapshot.size} môn học!`);
    } catch (err) {
      console.error("Lỗi khi xóa tất cả tasks:", err);
      alert("Đã xảy ra lỗi khi xóa. Vui lòng thử lại!");
    } finally {
      setLoading(false);
    }
  }

  async function copyLastWeekSchedule() {
    if (!confirm("Bạn có muốn sao chép toàn bộ lịch của tuần trước sang tuần này không?")) return;
    setLoading(true);
    const lastWeekDate = new Date(currentDate);
    lastWeekDate.setDate(currentDate.getDate() - 7);
    const { start: lastStart, end: lastEnd } = getWeekDateRange(lastWeekDate);
    const q = query(tasksCollectionRef, where("date", ">=", formatDate(lastStart)), where("date", "<=", formatDate(lastEnd)));
    try {
      const snap = await getDocs(q);
      if (snap.empty) { 
        alert("Không tìm thấy môn học nào ở tuần trước để sao chép!"); 
        setLoading(false);
        return; 
      }
      const { start: currentWeekStart } = getWeekDateRange(currentDate);
      const batch = writeBatch(db);
      snap.forEach(docSnap => {
        const t = docSnap.data();
        const offset = dayMap[t.day];
        if (offset !== undefined) {
          const newDate = new Date(currentWeekStart);
          newDate.setDate(currentWeekStart.getDate() + offset);
          const newTask = { 
            ...t, 
            date: formatDate(newDate), 
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            order: t.order || 1
          };
          const newRef = doc(collection(db, "artifacts", appId, "public", "data", "tasks"));
          batch.set(newRef, newTask);
        }
      });
      await batch.commit();
      alert(`Đã sao chép ${snap.size} môn học từ tuần trước!`);
    } catch (err) {
      console.error("Lỗi khi commit batch:", err);
      alert("Đã xảy ra lỗi khi sao chép. Vui lòng thử lại!");
    } finally {
      setLoading(false);
    }
  }

  // Modal handlers
  window.openAddTaskModal = (dayOrDate) => {
    if (currentRole === 'viewer') { alert('Bạn chỉ có quyền xem!'); return; }
    currentEditingTask = null;
    document.getElementById('modal-title').textContent = 'Thêm môn học';
    const taskText = document.getElementById('task-text');
    taskText.value = '';
    document.getElementById('delete-task-btn').classList.add('hidden');
    document.getElementById('task-color').value = '#e85499';
    document.getElementById('task-last-updated').textContent = '';
    if (typeof dayOrDate === 'string' && dayMap[dayOrDate] !== undefined) {
      document.getElementById('task-day').value = dayOrDate;
      const { start } = getWeekDateRange(currentDate);
      const d = new Date(start); d.setDate(start.getDate() + dayMap[dayOrDate]);
      document.getElementById('task-date').value = formatDate(d);
    } else if (dayOrDate) {
      const dt = (dayOrDate instanceof Date) ? dayOrDate : new Date(dayOrDate);
      const weekDay = dt.getDay();
      const key = weekDay === 0 ? 'CN' : dayIndexToKey[weekDay - 1];
      document.getElementById('task-day').value = key;
      document.getElementById('task-date').value = formatDate(dt);
    }
    document.getElementById('task-modal').classList.remove('hidden');
    setTimeout(() => taskText.focus(), 100);
  };

  window.openEditTaskModal = (task) => {
    currentEditingTask = task;
    document.getElementById('modal-title').textContent = 'Sửa môn học';
    const taskText = document.getElementById('task-text');
    taskText.value = task.text || '';
    document.getElementById('task-day').value = task.day || 'T2';
    document.getElementById('task-color').value = task.color || '#e85499';
    document.getElementById('task-date').value = task.date || '';
    document.getElementById('task-last-updated').textContent = task.updatedAt ? 
      `Sửa lần cuối: ${new Date(task.updatedAt).toLocaleString('vi-VN')}` : '';
    // If current role cannot delete, hide delete button
    if (currentRole !== 'admin') {
      document.getElementById('delete-task-btn').classList.add('hidden');
    } else {
      document.getElementById('delete-task-btn').classList.remove('hidden');
    }
    document.getElementById('task-modal').classList.remove('hidden');
    setTimeout(() => {
      taskText.focus();
      taskText.select();
    }, 100);
  };

  window.closeModal = () => {
    document.getElementById('task-modal').classList.add('hidden');
    currentEditingTask = null;
  };

  // Save task with role checks
  window.saveTask = async () => {
    if (currentRole === 'viewer') { alert('Bạn không có quyền thực hiện hành động này'); return; }
    const text = document.getElementById('task-text').value.trim();
    if (!text) { 
      alert('Vui lòng nhập nội dung môn học!'); 
      document.getElementById('task-text').focus();
      return; 
    }
    const day = document.getElementById('task-day').value;
    const dateVal = document.getElementById('task-date').value;
    const { start } = getWeekDateRange(currentDate);
    const d = new Date(start); d.setDate(start.getDate() + dayMap[day]);
    const finalDate = dateVal || formatDate(d);
    const payload = { 
      text, day, 
      color: document.getElementById('task-color').value || '#e85499', 
      date: finalDate, 
      updatedAt: new Date().toISOString()
    };
    setLoading(true);
    try {
      if (currentEditingTask && currentEditingTask.id) {
        payload.order = currentEditingTask.order || 1;
        const ref = doc(db, "artifacts", appId, "public", "data", "tasks", currentEditingTask.id);
        await setDoc(ref, payload, { merge: true });
      } else {
        payload.createdAt = new Date().toISOString();
        const container = document.getElementById(`tasks-${day}`);
        payload.order = container ? container.children.length + 1 : 1;
        await setDoc(doc(collection(db, "artifacts", appId, "public", "data", "tasks")), payload);
      }
      closeModal();
    } catch (err) {
      console.error("Lưu lỗi:", err);
      alert("Lỗi khi lưu. Vui lòng thử lại!");
    } finally {
      setLoading(false);
    }
  };

  // Delete task (admin only)
  window.deleteTask = async () => {
    if (currentRole !== 'admin') { alert('Chỉ admin được xoá!'); return; }
    if (!currentEditingTask || !currentEditingTask.id || !confirm('Bạn có chắc muốn xóa môn học này không?')) return;
    setLoading(true);
    try {
      await deleteDoc(doc(db, "artifacts", appId, "public", "data", "tasks", currentEditingTask.id));
      closeModal();
    } catch (err) {
      console.error("Xóa lỗi:", err);
      alert("Lỗi khi xóa. Vui lòng thử lại!");
    } finally {
      setLoading(false);
    }
  };

  // Navigation debounce
  const debouncedWeekNavigation = debounce((direction) => {
    currentDate.setDate(currentDate.getDate() + (direction * 7));
    setupWeekListener();
  }, 100);

  // UI interactions
  document.getElementById('prev-week-btn').addEventListener('click', () => debouncedWeekNavigation(-1));
  document.getElementById('next-week-btn').addEventListener('click', () => debouncedWeekNavigation(1));
  document.getElementById('theme-toggle-btn').addEventListener('click', (e) => {
    e.stopPropagation();
    updateTheme(currentTheme === 'light' ? 'dark' : 'light');
    closeSidebar();
  });

  // Sidebar management
  const sidebar = document.getElementById('sidebar');
  const menuToggle = document.getElementById('menu-toggle');
  const sidebarClose = document.getElementById('sidebar-close');
  function openSidebar() { sidebar.classList.remove('translate-x-full'); }
  function closeSidebar() { sidebar.classList.add('translate-x-full'); }
  menuToggle.addEventListener('click', e => { e.stopPropagation(); openSidebar(); });
  sidebarClose.addEventListener('click', closeSidebar);
  document.addEventListener('click', (e) => {
    if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
      closeSidebar();
    }
  });

  // Sidebar actions
  document.getElementById('copy-last-week-btn').addEventListener('click', async (e) => { 
    e.stopPropagation(); await copyLastWeekSchedule(); closeSidebar(); 
  });
  document.getElementById('copy-last-week-btn-inline').addEventListener('click', copyLastWeekSchedule);
  document.getElementById('delete-all-week-btn').addEventListener('click', async (e) => {
    e.stopPropagation(); await deleteAllWeekTasks(); closeSidebar();
  });

  // Modal backdrop and keyboard shortcuts
  document.getElementById('task-modal').addEventListener('click', e => { 
    if (e.target === e.currentTarget) closeModal(); 
  });

  document.addEventListener('keydown', throttle((e) => {
    const modalHidden = document.getElementById('task-modal').classList.contains('hidden');
    if (e.key === 'Escape') {
      if (!modalHidden) closeModal();
      else if (!sidebar.classList.contains('translate-x-full')) closeSidebar();
    }
    if (e.key === 'Enter' && !modalHidden && !isLoading) {
      e.preventDefault(); window.saveTask();
    }
    if (modalHidden && !isLoading && e.ctrlKey) {
      if (e.key === 'ArrowLeft') { e.preventDefault(); debouncedWeekNavigation(-1); }
      else if (e.key === 'ArrowRight') { e.preventDefault(); debouncedWeekNavigation(1); }
    }
  }, 100));

  // ------------------
  // AUTHENTICATION
  // ------------------
  function setupAuthUiBindings() {
    const authOpenBtn = document.getElementById('auth-open-btn');
    const authModal = document.getElementById('auth-modal');
    const authSubmit = document.getElementById('auth-submit');
    const toggleAuthMode = document.getElementById('toggle-auth-mode');
    const authTitle = document.getElementById('auth-title');

    authOpenBtn.addEventListener('click', () => {
      document.getElementById('auth-email').value = '';
      document.getElementById('auth-password').value = '';
      isSignupMode = false;
      authTitle.textContent = 'Đăng nhập';
      authSubmit.textContent = 'Đăng nhập';
      document.getElementById('auth-modal').classList.remove('hidden');
    });

    toggleAuthMode.addEventListener('click', () => {
      isSignupMode = !isSignupMode;
      if (isSignupMode) {
        authTitle.textContent = 'Đăng ký';
        authSubmit.textContent = 'Đăng ký';
        toggleAuthMode.textContent = 'Đã có tài khoản? Đăng nhập';
      } else {
        authTitle.textContent = 'Đăng nhập';
        authSubmit.textContent = 'Đăng nhập';
        toggleAuthMode.textContent = 'Chưa có tài khoản? Đăng ký';
      }
    });

    authSubmit.addEventListener('click', handleAuthSubmit);
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await signOut(auth);
    });

    authModal.addEventListener('click', (e) => {
      if (e.target === authModal) authModal.classList.add('hidden');
    });
  }

  let isSignupMode = false;

  async function handleAuthSubmit() {
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;
    if (!email || !password) { alert('Vui lòng nhập email và mật khẩu'); return; }
    try {
      setLoading(true);
      if (isSignupMode) {
        // create account, default role = viewer
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, 'users', cred.user.uid), { email, role: 'viewer', createdAt: new Date().toISOString() });
        alert('Đăng ký thành công. Bạn đã được đăng nhập tự động.');
      } else {
        await signInWithEmailAndPassword(auth, email, password);
      }
      document.getElementById('auth-modal').classList.add('hidden');
    } catch (err) {
      console.error('Auth error:', err);
      alert('Lỗi xác thực: ' + (err.message || err));
    } finally {
      setLoading(false);
    }
  }

  // Listen to auth state changes
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('user-email-display').textContent = user.email;
      document.getElementById('user-email-display').classList.remove('hidden');
      document.getElementById('auth-open-btn').classList.add('hidden');
      document.getElementById('logout-btn').classList.remove('hidden');
      // fetch role from users collection
      try {
        const uDoc = await getDoc(doc(db, 'users', user.uid));
        currentRole = uDoc.exists() && uDoc.data().role ? uDoc.data().role : 'viewer';
      } catch (err) {
        console.error('Lỗi lấy role:', err);
        currentRole = 'viewer';
      }
      applyPermissions();
      if (currentRole === 'admin') {
        document.getElementById('admin-users-section').classList.remove('hidden');
        loadUsersList();
      } else {
        document.getElementById('admin-users-section').classList.add('hidden');
      }
    } else {
      currentUser = null;
      currentRole = 'viewer';
      document.getElementById('user-email-display').classList.add('hidden');
      document.getElementById('auth-open-btn').classList.remove('hidden');
      document.getElementById('logout-btn').classList.add('hidden');
      applyPermissions();
      document.getElementById('admin-users-section').classList.add('hidden');
    }
  });

  // Apply UI permission changes based on role
  function applyPermissions() {
    const addBtns = document.querySelectorAll('.add-btn');
    if (currentRole === 'viewer') {
      addBtns.forEach(btn => btn.style.display = 'none');
      document.getElementById('delete-all-week-btn').style.display = 'none';
    } else if (currentRole === 'editor') {
      addBtns.forEach(btn => btn.style.display = 'inline-block');
      document.getElementById('delete-all-week-btn').style.display = 'none';
    } else if (currentRole === 'admin') {
      addBtns.forEach(btn => btn.style.display = 'inline-block');
      document.getElementById('delete-all-week-btn').style.display = 'flex';
    }
  }

  // ------------------
  // Admin: load & manage users (mở rộng: tạo record user, đánh dấu invite)
  // ------------------
  async function loadUsersList() {
    const usersListEl = document.getElementById('users-list');
    usersListEl.innerHTML = '<div class="text-sm text-secondary">Đang tải...</div>';
    try {
      const snapshot = await getDocs(usersCollectionRef);
      usersListEl.innerHTML = '';
      snapshot.forEach(docSnap => {
        const u = docSnap.data();
        const row = document.createElement('div');
        row.className = 'p-2 border rounded flex items-center justify-between gap-2';
        row.innerHTML = `
          <div class="flex-1">
            <div class="font-medium text-sm">${u.email || '(no email)'}</div>
            <div class="text-xs text-secondary">uid: ${docSnap.id}</div>
            <div class="text-xs text-secondary">createdAt: ${u.createdAt ? new Date(u.createdAt).toLocaleString('vi-VN') : '-'}</div>
          </div>
          <div class="flex items-center gap-2">
            <select data-uid="${docSnap.id}" class="role-select border p-1 rounded">
              <option value="viewer">viewer</option>
              <option value="editor">editor</option>
              <option value="admin">admin</option>
            </select>
            <button data-uid="${docSnap.id}" class="delete-user-btn px-2 py-1 bg-red-500 text-white rounded text-xs">Xóa</button>
          </div>
        `;
        usersListEl.appendChild(row);
        // set current role
        const sel = row.querySelector('.role-select');
        sel.value = u.role || 'viewer';
        sel.addEventListener('change', async (e) => {
          const newRole = e.target.value;
          const uid = e.target.dataset.uid;
          if (!confirm(`Gán role "${newRole}" cho user này?`)) {
            e.target.value = u.role || 'viewer';
            return;
          }
          try {
            await setDoc(doc(db, 'users', uid), { role: newRole }, { merge: true });
            alert('Cập nhật role thành công.');
            loadUsersList(); // refresh
          } catch (err) {
            console.error('Lỗi cập nhật role:', err);
            alert('Cập nhật thất bại.');
          }
        });
        const delBtn = row.querySelector('.delete-user-btn');
        delBtn.addEventListener('click', async (e) => {
          const uid = e.target.dataset.uid;
          if (!confirm('Xóa user khỏi collection `users`? (không xóa tài khoản Auth)')) return;
          try {
            await deleteDoc(doc(db, 'users', uid));
            alert('Đã xóa user record (Auth vẫn tồn tại, nếu muốn xóa Auth, làm thủ công trên Firebase Console).');
            loadUsersList();
          } catch (err) {
            console.error('Lỗi xóa user:', err);
            alert('Xóa thất bại.');
          }
        });
      });
    } catch (err) {
      console.error('Lỗi load users:', err);
      usersListEl.innerHTML = '<div class="text-sm text-red-500">Lỗi khi tải danh sách user.</div>';
    }
  }

  // Create user record (admin)
  document.getElementById('create-user-record-btn').addEventListener('click', async () => {
    if (currentRole !== 'admin') { alert('Chỉ admin mới tạo được user record'); return; }
    const email = document.getElementById('new-user-email').value.trim();
    const role = document.getElementById('new-user-role').value;
    if (!email) { alert('Nhập email'); return; }
    try {
      setLoading(true);
      // create a document with generated uid (Firestore auto id) and email+role
      await addDoc(usersCollectionRef, { email, role, createdAt: new Date().toISOString() });
      alert('Tạo user record thành công (không tạo tài khoản Auth).');
      document.getElementById('new-user-email').value = '';
      loadUsersList();
    } catch (err) {
      console.error('Lỗi tạo user record:', err);
      alert('Tạo thất bại.');
    } finally {
      setLoading(false);
    }
  });

  // Create user record + mark invite (dùng để lưu email invite)
  document.getElementById('invite-user-btn').addEventListener('click', async () => {
    if (currentRole !== 'admin') { alert('Chỉ admin mới mời user'); return; }
    const email = document.getElementById('new-user-email').value.trim();
    const role = document.getElementById('new-user-role').value;
    if (!email) { alert('Nhập email'); return; }
    try {
      setLoading(true);
      // create an 'invites' collection or flag in users collection
      const inviteRef = await addDoc(collection(db, 'invites'), { email, role, invitedAt: new Date().toISOString(), invitedBy: currentUser ? currentUser.uid : null });
      // also write a user-doc record for admin convenience (optional)
      await addDoc(usersCollectionRef, { email, role, invited: true, inviteRefId: inviteRef.id, createdAt: new Date().toISOString() });
      alert('Đã lưu invite. Bạn có thể gửi email mời người dùng (bằng hệ thống mail bên ngoài).');
      document.getElementById('new-user-email').value = '';
      loadUsersList();
    } catch (err) {
      console.error('Lỗi invite:', err);
      alert('Thất bại khi lưu invite.');
    } finally {
      setLoading(false);
    }
  });

  document.getElementById('refresh-users-btn').addEventListener('click', loadUsersList);

  // ------------------
  // Initialization
  // ------------------
  function init() {
    try {
      updateTheme(currentTheme);
      initDayCardDropHandlers();
      setupWeekListener();
      setupAuthUiBindings();
      console.log('App initialized successfully (month view removed)');
    } catch (error) {
      console.error('Initialization error:', error);
      document.getElementById('sync-dot').style.backgroundColor = 'red';
    }
  }

  init();

  // Notes & security reminder:
  // - Đây vẫn là kiểm tra phân quyền *bên client* để ẩn/hiện UI. Bắt buộc phải bổ sung Firestore Security Rules
  //   để bảo vệ các thao tác create/update/delete theo role.
  // - Ví dụ rule gợi ý (Firestore Rules) — admin mới được delete users/tasks, editor được write tasks, viewer chỉ read:
  //   match /databases/{database}/documents {
  //     match /users/{userId} {
  //       allow read: if request.auth != null;
  //       allow create: if request.auth != null;
  //       allow update, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
  //     }
  //     match /artifacts/{proj}/public/data/tasks/{taskId} {
  //       allow read: if true;
  //       allow create, update: if request.auth != null && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin','editor']);
  //       allow delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
  //     }
  //   }

</script>

</body>
</html>
