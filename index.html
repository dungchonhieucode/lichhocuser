<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lịch học, việc cần làm</title>

  <!-- Preload critical resources -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

  <style>
    :root {
      --bg-primary: #f9fafb;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f3f4f6;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --border-color: #d1d5db;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    [data-theme="dark"] {
      --bg-primary: #111827;
      --bg-secondary: #1f2937;
      --bg-tertiary: #374151;
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --border-color: #4b5563;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
    }

    * {
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    body { 
      font-family: 'Inter', sans-serif; 
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }

    .app-bg { background-color: var(--bg-primary); }
    .card-bg { background-color: var(--bg-secondary); }
    .surface-bg { background-color: var(--bg-tertiary); }
    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .border-custom { border-color: var(--border-color); }
    .shadow-custom { box-shadow: var(--shadow); }
    .shadow-lg-custom { box-shadow: var(--shadow-lg); }

    .day-card { 
      border-radius: 16px; 
      min-height: 160px; 
      transition: transform .12s, box-shadow .12s, background-color 0.2s ease; 
      padding: 1rem;
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
    }

    .day-card.drag-over { 
      box-shadow: 0 0 0 4px rgba(91,33,182,0.25); 
      transform: scale(1.02); 
    }

    .task-item { 
      border-radius: 12px; 
      padding: 0.5rem; 
      margin-top: .5rem; 
      color: #1f2937; 
      cursor: grab; 
      user-select: none; 
      font-weight: 500;
      transition: all 0.2s ease;
      position: relative;
    }

    .task-item:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .task-item.dragging { 
      opacity: .6; 
      transform: rotate(5deg);
      z-index: 1000;
    }

    .task-item.drag-placeholder {
      opacity: 0.3;
      background-color: #e5e7eb !important;
      border: 2px dashed #9ca3af;
    }

    .task-item .drag-handle {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0;
      transition: opacity 0.2s ease;
      cursor: grab;
      color: rgba(255,255,255,0.7);
      font-size: 12px;
    }

    .task-item:hover .drag-handle {
      opacity: 1;
    }

    .task-container {
      min-height: 20px;
    }

    .task-container.drag-over-container {
      background-color: rgba(91,33,182,0.1);
      border-radius: 8px;
    }

    #sidebar { 
      z-index: 60; 
      right: 0; 
      top: 0;
      background-color: var(--bg-secondary);
      box-shadow: var(--shadow-lg);
      border-left: 1px solid var(--border-color);
    }

    #current-week-display { 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis; 
    }

    .modal-bg {
      background-color: var(--bg-secondary);
      box-shadow: var(--shadow-lg);
    }

    .input-custom {
      background-color: var(--bg-secondary);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    .input-custom:focus {
      outline: none;
      ring: 2px;
      ring-color: #8b5cf6;
    }

    .btn-hover:hover {
      filter: brightness(0.9);
    }

    /* Dark mode calendar styles */
    [data-theme="dark"] .fc {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
    }

    [data-theme="dark"] .fc-theme-standard td,
    [data-theme="dark"] .fc-theme-standard th {
      border-color: var(--border-color);
    }

    [data-theme="dark"] .fc-button {
      background-color: #8b5cf6;
      border-color: #8b5cf6;
    }

    [data-theme="dark"] .fc-button:hover {
      background-color: #7c3aed;
      border-color: #7c3aed;
    }

    [data-theme="dark"] .fc-daygrid-day {
      background-color: var(--bg-secondary);
    }

    [data-theme="dark"] .fc-col-header-cell {
      background-color: var(--bg-tertiary);
    }

    /* Loading spinner */
    .spinner {
      border: 2px solid var(--border-color);
      border-top: 2px solid #8b5cf6;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Performance optimizations */
    .day-card, .task-item {
      contain: layout style;
      will-change: transform;
    }

    /* Color variations for days in dark mode */
    [data-theme="dark"] .day-pink { background-color: #4c1d95; }
    [data-theme="dark"] .day-purple { background-color: #581c87; }
    [data-theme="dark"] .day-blue { background-color: #1e3a8a; }
    [data-theme="dark"] .day-green { background-color: #14532d; }
    [data-theme="dark"] .day-yellow { background-color: #92400e; }
    [data-theme="dark"] .day-stone { background-color: #44403c; }
    [data-theme="dark"] .day-gray { background-color: #374151; }

    .day-pink { background-color: #fce7f3; }
    .day-purple { background-color: #f3e8ff; }
    .day-blue { background-color: #dbeafe; }
    .day-green { background-color: #dcfce7; }
    .day-yellow { background-color: #fef3c7; }
    .day-stone { background-color: #f5f5f4; }
    .day-gray { background-color: #f3f4f6; }
  </style>

  <script>
    // Theme detection and application (before DOM load for no flash)
    (function() {
      const savedTheme = localStorage.getItem('theme') || 
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', savedTheme);
    })();
  </script>
</head>
<body class="p-4 app-bg text-primary">

<div class="container mx-auto max-w-4xl">
  <!-- Header -->
  <header class="flex justify-between items-center py-2 px-4">
    <h1 class="text-xl sm:text-2xl font-bold text-primary">Lịch học</h1>
    <div class="flex items-center gap-3">
      <div id="auth-container" class="flex items-center gap-2">
        <span id="user-display" class="text-sm text-secondary hidden"></span>
        <button id="auth-btn" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm transition-colors">Đăng nhập</button>
      </div>
      <div id="sync-indicator" class="flex items-center gap-2">
        <span id="sync-dot" class="inline-block w-3 h-3 rounded-full bg-gray-400"></span>
        <div id="loading-spinner" class="spinner hidden"></div>
      </div>
      <button id="menu-toggle" class="text-secondary p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </header>

  <!-- Navigation -->
  <div class="flex items-center p-2 gap-2">
    <button id="prev-week-btn" class="px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm btn-hover transition-all">
      <i class="fas fa-arrow-left"></i>
    </button>
    <div class="text-center flex-1 px-2">
      <h2 id="current-week-display" class="text-sm font-semibold text-primary"></h2>
      <div class="text-xs text-blue-500 mt-1 hidden sm:block">
        <button id="copy-last-week-btn-inline" class="underline hover:text-blue-700 transition-colors">Sao chép lịch từ tuần trước</button>
      </div>
    </div>
    <button id="next-week-btn" class="px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm btn-hover transition-all">
      <i class="fas fa-arrow-right"></i>
    </button>
  </div>

  <!-- Week view -->
  <div id="week-view" class="grid grid-cols-2 lg:grid-cols-3 gap-3 p-4">
    <div id="T2" class="day-card day-pink"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-primary">T2</h3><button data-permission="create" onclick="openAddTaskModal('T2')" class="text-xl hover:bg-pink-200 dark:hover:bg-pink-800 rounded px-2 transition-colors text-primary">+</button></div><div id="tasks-T2" class="task-container"></div></div>
    <div id="T3" class="day-card day-purple"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-primary">T3</h3><button data-permission="create" onclick="openAddTaskModal('T3')" class="text-xl hover:bg-purple-200 dark:hover:bg-purple-800 rounded px-2 transition-colors text-primary">+</button></div><div id="tasks-T3" class="task-container"></div></div>
    <div id="T4" class="day-card day-blue"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-primary">T4</h3><button data-permission="create" onclick="openAddTaskModal('T4')" class="text-xl hover:bg-blue-200 dark:hover:bg-blue-800 rounded px-2 transition-colors text-primary">+</button></div><div id="tasks-T4" class="task-container"></div></div>
    <div id="T5" class="day-card day-green"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-primary">T5</h3><button data-permission="create" onclick="openAddTaskModal('T5')" class="text-xl hover:bg-green-200 dark:hover:bg-green-800 rounded px-2 transition-colors text-primary">+</button></div><div id="tasks-T5" class="task-container"></div></div>
    <div id="T6" class="day-card day-yellow"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-primary">T6</h3><button data-permission="create" onclick="openAddTaskModal('T6')" class="text-xl hover:bg-yellow-200 dark:hover:bg-yellow-800 rounded px-2 transition-colors text-primary">+</button></div><div id="tasks-T6" class="task-container"></div></div>
    <div id="T7" class="day-card day-stone"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-primary">T7</h3><button data-permission="create" onclick="openAddTaskModal('T7')" class="text-xl hover:bg-stone-200 dark:hover:bg-stone-800 rounded px-2 transition-colors text-primary">+</button></div><div id="tasks-T7" class="task-container"></div></div>
    <div id="CN" class="day-card day-gray"><div class="flex justify-between items-start mb-2"><h3 class="font-semibold text-primary">CN</h3><button data-permission="create" onclick="openAddTaskModal('CN')" class="text-xl hover:bg-gray-300 dark:hover:bg-gray-600 rounded px-2 transition-colors text-primary">+</button></div><div id="tasks-CN" class="task-container"></div></div>
  </div>

  <!-- Month view -->
  <div id="month-view" class="hidden p-4">
    <div id='calendar' class="card-bg rounded-lg"></div>
  </div>
</div>

<!-- Sidebar -->
<div id="sidebar" class="fixed top-0 right-0 w-72 h-full card-bg shadow-lg-custom border-custom transform translate-x-full transition-transform duration-300 ease-in-out">
  <div class="p-4 space-y-4">
    <div class="flex justify-between items-center">
      <h3 class="font-semibold text-lg text-primary">Tùy chọn</h3>
      <button id="sidebar-close" class="text-secondary p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i class="fas fa-times"></i></button>
    </div>

    <button id="theme-toggle-btn" class="w-full flex items-center gap-2 px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg transition-colors btn-hover"><i id="theme-icon" class="fas fa-moon"></i><span id="theme-text">Chế độ tối</span></button>
    <button id="copy-last-week-btn" class="w-full flex items-center gap-2 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors btn-hover"><i class="fas fa-copy"></i><span>Sao chép tuần trước</span></button>
    <button id="toggle-view-btn" class="w-full flex items-center gap-2 px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors btn-hover"><i id="view-icon" class="fas fa-calendar"></i><span id="view-text">Chuyển xem tháng</span></button>
    <button id="delete-all-week-btn" data-permission="delete" class="w-full flex items-center gap-2 px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors btn-hover"><i class="fas fa-trash-alt"></i><span>Xóa tất cả tuần này</span></button>
    <button id="manage-users-btn" data-permission="admin-only" class="w-full flex items-center gap-2 px-3 py-2 bg-gray-700 hover:bg-gray-800 text-white rounded-lg transition-colors btn-hover"><i class="fas fa-users-cog"></i><span>Quản lý User</span></button>
  </div>
</div>

<!-- Modal Thêm/Sửa Task -->
<div id="task-modal" class="fixed inset-0 bg-gray-800 bg-opacity-40 flex items-center justify-center p-4 hidden z-50">
  <div class="modal-bg p-5 rounded-xl w-full max-w-sm shadow-lg-custom">
    <h2 id="modal-title" class="text-lg font-semibold mb-3 text-primary">Thêm môn học</h2>
    <input id="task-text" class="w-full border rounded p-2 mb-2 input-custom border-custom" placeholder="Nội dung môn / việc"/>
    <div class="flex gap-2 mb-2">
      <select id="task-day" class="flex-1 border rounded p-2 input-custom border-custom">
        <option value="T2">Thứ 2</option><option value="T3">Thứ 3</option><option value="T4">Thứ 4</option>
        <option value="T5">Thứ 5</option><option value="T6">Thứ 6</option><option value="T7">Thứ 7</option>
        <option value="CN">Chủ Nhật</option>
      </select>
      <input id="task-color" type="color" class="w-14 p-0 rounded border border-custom" value="#e85499"/>
    </div>
    <input id="task-date" type="date" class="hidden"/>
    <div id="task-last-updated" class="text-xs text-secondary mb-2"></div>
    <div class="flex justify-end gap-2">
      <button id="delete-task-btn" onclick="deleteTask()" class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded hidden transition-colors btn-hover">Xóa</button>
      <button onclick="closeModal()" class="px-3 py-2 surface-bg hover:bg-gray-300 dark:hover:bg-gray-600 rounded transition-colors text-primary">Hủy</button>
      <button id="save-task-btn" onclick="saveTask()" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded transition-colors btn-hover">Lưu</button>
    </div>
  </div>
</div>

<!-- Modal Quản lý User -->
<div id="user-management-modal" class="fixed inset-0 bg-gray-800 bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
  <div class="modal-bg p-5 rounded-xl w-full max-w-2xl shadow-lg-custom max-h-[80vh] flex flex-col">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold text-primary">Quản lý phân quyền User</h2>
      <button onclick="closeUserManagementModal()" class="text-2xl text-secondary">&times;</button>
    </div>
    <div id="user-list-container" class="overflow-y-auto space-y-2 text-sm">
      <!-- Danh sách user sẽ được render vào đây -->
    </div>
  </div>
</div>


<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, where, writeBatch, getDocs, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { getAuth, GoogleAuthProvider, onAuthStateChanged, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDUQpOlvgn1TwT8TkfdHyesl1bc3Qbn0pM",
    authDomain: "dulieulichhoc.firebaseapp.com",
    projectId: "dulieulichhoc",
    storageBucket: "dulieulichhoc.firebasestorage.app",
    messagingSenderId: "46236518897",
    appId: "1:46236518897:web:8a6692006e802902965c50"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const appId = firebaseConfig.projectId;
  const tasksCollectionRef = collection(db, "artifacts", appId, "public", "data", "tasks");
  const usersCollectionRef = collection(db, "users");

  // Performance optimizations
  const debounce = (func, wait) => {
    let timeout;
    return function executedFunction(...args) {
      const later = () => { clearTimeout(timeout); func(...args); };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  };
  const throttle = (func, limit) => {
    let inThrottle;
    return function() {
      const args = arguments;
      const context = this;
      if (!inThrottle) {
        func.apply(context, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    }
  };

  // State
  let currentUser = null; // Từ Firebase Auth
  let currentUserPermissions = null; // Từ collection 'users'
  let currentEditingTask = null;
  let currentDate = new Date();
  let draggedElement = null;
  let calendarVisible = false;
  let calendarInstance = null;
  let currentTheme = localStorage.getItem('theme') || 'light';
  let tasksCache = new Map();
  let isLoading = false;
  let currentWeekId = null;
  let unsubscribeWeek = null;
  let unsubscribeMonth = null;
  
  const dayMap = { 'T2':0,'T3':1,'T4':2,'T5':3,'T6':4,'T7':5,'CN':6 };
  const dayIndexToKey = ['T2','T3','T4','T5','T6','T7','CN'];

  // --- HÀM KIỂM TRA QUYỀN ---
  function hasPermission(permission) {
    if (!currentUserPermissions) return false;
    if (currentUserPermissions.role === 'admin') return true;
    return currentUserPermissions.permissions?.[permission] === true;
  }

  // --- CẬP NHẬT UI DỰA TRÊN QUYỀN ---
  function updateUIWithPermissions() {
    // Ẩn/hiện các nút thêm task
    document.querySelectorAll('button[data-permission="create"]').forEach(btn => {
        btn.style.display = hasPermission('create') ? 'block' : 'none';
    });

    // Ẩn/hiện các nút chỉ dành cho admin
    document.querySelectorAll('[data-permission="admin-only"]').forEach(el => {
        el.style.display = currentUserPermissions?.role === 'admin' ? 'flex' : 'none';
    });
    
    // Nút xóa tất cả tuần
    document.querySelector('[data-permission="delete"]').style.display = hasPermission('delete') ? 'flex' : 'none';
  }

  // --- LOGIC XỬ LÝ AUTHENTICATION ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      const userDocRef = doc(db, "users", user.uid);
      const userDocSnap = await getDoc(userDocRef);

      if (userDocSnap.exists()) {
        currentUserPermissions = userDocSnap.data();
      } else {
        const defaultPermissions = {
          email: user.email,
          displayName: user.displayName,
          role: 'user', // Mặc định là user thường
          permissions: {
            create: false,
            edit: false,
            delete: false
          }
        };
        await setDoc(userDocRef, defaultPermissions);
        currentUserPermissions = defaultPermissions;
      }
    } else {
      currentUser = null;
      currentUserPermissions = null;
    }
    updateAuthUI(user);
    updateUIWithPermissions();
  });

  const signIn = () => signInWithPopup(auth, provider).catch(err => console.error("Login error:", err));
  const logOut = () => signOut(auth).catch(err => console.error("Logout error:", err));

  function updateAuthUI(user) {
    const authBtn = document.getElementById('auth-btn');
    const userDisplay = document.getElementById('user-display');
    if (user) {
      userDisplay.textContent = user.displayName || user.email;
      userDisplay.classList.remove('hidden');
      authBtn.textContent = 'Đăng xuất';
      authBtn.onclick = logOut;
    } else {
      userDisplay.classList.add('hidden');
      authBtn.textContent = 'Đăng nhập';
      authBtn.onclick = signIn;
    }
  }

  // --- CẬP NHẬT CÁC HÀM CRUD ĐỂ KIỂM TRA QUYỀN ---
  window.openAddTaskModal = (dayOrDate) => {
    if (!hasPermission('create')) {
      alert("Bạn không có quyền thêm môn học.");
      return;
    }
    currentEditingTask = null;
    document.getElementById('modal-title').textContent = 'Thêm môn học';
    const taskText = document.getElementById('task-text');
    taskText.value = '';
    document.getElementById('delete-task-btn').classList.add('hidden');
    document.getElementById('task-color').value = '#e85499';
    document.getElementById('task-last-updated').textContent = '';

    if (typeof dayOrDate === 'string' && dayMap[dayOrDate] !== undefined) {
      document.getElementById('task-day').value = dayOrDate;
      const { start } = getWeekDateRange(currentDate);
      const d = new Date(start); d.setDate(start.getDate() + dayMap[dayOrDate]);
      document.getElementById('task-date').value = formatDate(d);
    } else if (dayOrDate) {
      const dt = (dayOrDate instanceof Date) ? dayOrDate : new Date(dayOrDate);
      const weekDay = dt.getDay();
      const key = weekDay === 0 ? 'CN' : dayIndexToKey[weekDay - 1];
      document.getElementById('task-day').value = key;
      document.getElementById('task-date').value = formatDate(dt);
    }
    
    document.getElementById('task-modal').classList.remove('hidden');
    setTimeout(() => taskText.focus(), 100);
  };

  window.openEditTaskModal = (task) => {
    currentEditingTask = task;
    document.getElementById('modal-title').textContent = 'Sửa môn học';
    const taskText = document.getElementById('task-text');
    taskText.value = task.text || '';
    document.getElementById('task-day').value = task.day || 'T2';
    document.getElementById('task-color').value = task.color || '#e85499';
    document.getElementById('task-date').value = task.date || '';
    document.getElementById('task-last-updated').textContent = task.updatedAt ? 
      `Sửa lần cuối: ${new Date(task.updatedAt).toLocaleString('vi-VN')}` : '';
    
    const saveBtn = document.getElementById('save-task-btn');
    const deleteBtn = document.getElementById('delete-task-btn');
    
    saveBtn.disabled = !hasPermission('edit');
    saveBtn.style.cursor = hasPermission('edit') ? 'pointer' : 'not-allowed';
    saveBtn.style.opacity = hasPermission('edit') ? '1' : '0.5';
    
    deleteBtn.style.display = hasPermission('delete') ? 'block' : 'none';
    
    document.getElementById('task-modal').classList.remove('hidden');
    setTimeout(() => {
      taskText.focus();
      taskText.select();
    }, 100);
  };

  window.saveTask = async () => {
    if (!currentEditingTask && !hasPermission('create')) {
        alert('Bạn không có quyền thêm môn học.');
        return;
    }
    if (currentEditingTask && !hasPermission('edit')) {
        alert('Bạn không có quyền sửa môn học.');
        return;
    }
    
    const text = document.getElementById('task-text').value.trim();
    if (!text) { 
      alert('Vui lòng nhập nội dung môn học!'); 
      document.getElementById('task-text').focus();
      return; 
    }
    
    const day = document.getElementById('task-day').value;
    const dateVal = document.getElementById('task-date').value;
    const { start } = getWeekDateRange(currentDate);
    const d = new Date(start); d.setDate(start.getDate() + dayMap[day]);
    const finalDate = dateVal || formatDate(d);
    
    const payload = { 
      text, day, 
      color: document.getElementById('task-color').value || '#e85499', 
      date: finalDate, 
      updatedAt: new Date().toISOString()
    };
    
    setLoading(true);
    try {
      if (currentEditingTask && currentEditingTask.id) {
        payload.order = currentEditingTask.order || 1;
        const ref = doc(db, "artifacts", appId, "public", "data", "tasks", currentEditingTask.id);
        await setDoc(ref, payload, { merge: true });
      } else {
        payload.createdAt = new Date().toISOString();
        const container = document.getElementById(`tasks-${day}`);
        payload.order = container ? container.children.length + 1 : 1;
        await setDoc(doc(tasksCollectionRef), payload);
      }
      closeModal();
    } catch (err) {
      console.error("Lỗi khi lưu:", err);
      alert("Lỗi khi lưu. Vui lòng thử lại! (Có thể bạn không có quyền thực hiện hành động này).");
    } finally {
      setLoading(false);
    }
  };

  window.deleteTask = async () => {
    if (!hasPermission('delete')) {
        alert("Bạn không có quyền xóa môn học.");
        return;
    }
    if (!currentEditingTask || !currentEditingTask.id || !confirm('Bạn có chắc muốn xóa môn học này không?')) return;
    
    setLoading(true);
    try {
      await deleteDoc(doc(db, "artifacts", appId, "public", "data", "tasks", currentEditingTask.id));
      closeModal();
    } catch (err) {
      console.error("Lỗi khi xóa:", err);
      alert("Lỗi khi xóa. Vui lòng thử lại!");
    } finally {
      setLoading(false);
    }
  };

  async function deleteAllWeekTasks() {
    if (!hasPermission('delete')) {
        alert("Bạn không có quyền thực hiện hành động này.");
        return;
    }
    if (!confirm("Bạn có chắc chắn muốn xóa TẤT CẢ môn học trong tuần này không?\n\nHành động này KHÔNG THỂ HOÀN TÁC!")) return;
    
    setLoading(true);
    const { start, end } = getWeekDateRange(currentDate);
    const q = query(tasksCollectionRef, where("date", ">=", formatDate(start)), where("date", "<=", formatDate(end)));
    
    try {
      const snapshot = await getDocs(q);
      if (snapshot.empty) {
        alert("Không có môn học nào trong tuần này để xóa!");
        setLoading(false);
        return;
      }
      const batch = writeBatch(db);
      snapshot.forEach(docSnap => batch.delete(docSnap.ref));
      await batch.commit();
      alert(`Đã xóa thành công ${snapshot.size} môn học!`);
    } catch (err) {
      console.error("Lỗi khi xóa tất cả tasks:", err);
      alert("Đã xảy ra lỗi khi xóa. Vui lòng thử lại!");
    } finally {
      setLoading(false);
    }
  }

  // --- LOGIC CHO MODAL QUẢN LÝ USER ---
  const userManagementModal = document.getElementById('user-management-modal');
  const userListContainer = document.getElementById('user-list-container');

  window.openUserManagementModal = async () => {
    const userDocs = await getDocs(usersCollectionRef);
    let html = `
      <div class="grid grid-cols-4 gap-2 font-bold p-2 border-b border-custom">
        <div>Email</div>
        <div class="text-center">Thêm</div>
        <div class="text-center">Sửa</div>
        <div class="text-center">Xóa</div>
      </div>
    `;

    userDocs.forEach(docSnap => {
        const user = docSnap.data();
        if (user.role === 'admin') return;

        const perms = user.permissions || {};
        html += `
          <div class="grid grid-cols-4 gap-2 items-center p-2 border-b border-custom hover:bg-tertiary">
            <div class="truncate" title="${user.email}">${user.displayName || user.email}</div>
            <div class="text-center"><input type="checkbox" data-uid="${docSnap.id}" data-perm="create" ${perms.create ? 'checked' : ''} class="w-5 h-5"></div>
            <div class="text-center"><input type="checkbox" data-uid="${docSnap.id}" data-perm="edit" ${perms.edit ? 'checked' : ''} class="w-5 h-5"></div>
            <div class="text-center"><input type="checkbox" data-uid="${docSnap.id}" data-perm="delete" ${perms.delete ? 'checked' : ''} class="w-5 h-5"></div>
          </div>
        `;
    });
    userListContainer.innerHTML = html;
    
    userListContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
      checkbox.addEventListener('change', async (e) => {
        const uid = e.target.dataset.uid;
        const perm = e.target.dataset.perm;
        const value = e.target.checked;
        
        const userDocRef = doc(db, "users", uid);
        try {
          await updateDoc(userDocRef, { [`permissions.${perm}`]: value });
          console.log(`Updated permission ${perm} for user ${uid} to ${value}`);
        } catch (error) {
          console.error("Failed to update permission:", error);
          alert("Lỗi! Không thể cập nhật quyền.");
          e.target.checked = !value;
        }
      });
    });

    userManagementModal.classList.remove('hidden');
  }

  window.closeUserManagementModal = () => {
    userManagementModal.classList.add('hidden');
  }

  document.getElementById('manage-users-btn').addEventListener('click', () => {
      openUserManagementModal();
      closeSidebar();
  });
  

  // --- CÁC HÀM CŨ VÀ EVENT LISTENERS (giữ nguyên không thay đổi nhiều) ---
  // (Phần này chứa các hàm như updateTheme, getWeekDateRange, formatDate, reorderTasksInDay, renderTasks, setupWeekListener, initializeCalendar, copyLastWeekSchedule, v.v...)
  // Vì chúng quá dài và không thay đổi, tôi sẽ không lặp lại toàn bộ ở đây để giữ câu trả lời gọn gàng.
  // Bạn chỉ cần đảm bảo rằng chúng vẫn có trong file của bạn.
  
  // Các hàm tiện ích
  function updateTheme(theme){currentTheme=theme,document.documentElement.setAttribute("data-theme",theme),localStorage.setItem("theme",theme),updateThemeButton(),calendarVisible&&calendarInstance&&setTimeout(()=>{calendarInstance.render()},100)}function updateThemeButton(){const e=document.getElementById("theme-icon"),t=document.getElementById("theme-text");"dark"===currentTheme?(e.className="fas fa-sun",t.textContent="Chế độ sáng"):(e.className="fas fa-moon",t.textContent="Chế độ tối")}function setLoading(e){isLoading=e;const t=document.getElementById("loading-spinner"),n=document.getElementById("sync-dot");e?(t.classList.remove("hidden"),n.style.backgroundColor="orange"):t.classList.add("hidden")}function updateViewButton(){const e=document.getElementById("view-text"),t=document.getElementById("view-icon");calendarVisible?(e.textContent="Chuyển xem tuần",t.className="fas fa-list"):(e.textContent="Chuyển xem tháng",t.className="fas fa-calendar")}function getWeekDateRange(e){const t=new Date(e),n=t.getDay(),o=0===n?6:n-1;t.setDate(e.getDate()-o),t.setHours(0,0,0,0);const s=new Date(t);return s.setDate(t.getDate()+6),s.setHours(23,59,59,999),{start:t,end:s}}function formatDate(e){if("string"==typeof e)return e;const t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${t}-${n}-${o}`}function updateDateDisplay(){const{start:e,end:t}=getWeekDateRange(currentDate),n={day:"2-digit",month:"2-digit"};document.getElementById("current-week-display").textContent=`Tuần từ ${e.toLocaleDateString("vi-VN",n)} đến ${t.toLocaleDateString("vi-VN",n)}`}async function reorderTasksInDay(e,t){const n=Array.from(t).map((e,t)=>({id:e.dataset.taskId,order:t+1})),o=writeBatch(db);n.forEach(e=>{const t=doc(db,"artifacts",appId,"public","data","tasks",e.id);o.update(t,{order:e.order,updatedAt:(new Date).toISOString()})});try{await o.commit()}catch(e){console.error("Error reordering tasks:",e)}}const renderTasks=throttle(e=>{Object.keys(e).forEach(t=>{const n=document.getElementById(`tasks-${t}`);if(!n)return;const o=document.createDocumentFragment();e[t].sort((e,t)=>(e.order||0)-(t.order||0)||(e.text||"").localeCompare(t.text||"")),e[t].forEach((e,s)=>{const a=e.id+"-"+e.updatedAt+"-"+e.order;let r;if(tasksCache.has(a))r=tasksCache.get(a);else{r=document.createElement("div"),r.className="task-item p-2 mb-1 rounded transition-all hover:shadow-md",r.style.backgroundColor=e.color||"#e85499",r.textContent=e.text||"(không tên)",r.setAttribute("draggable","true");const t=document.createElement("i");t.className="fas fa-grip-lines drag-handle",r.appendChild(t),tasksCache.set(a,r)}r.dataset.taskId=e.id,r.dataset.taskDay=e.day||"",r.dataset.taskDate=e.date||"",r.dataset.taskOrder=e.order||s,setupTaskEventListeners(r,e,t),o.appendChild(r)}),n.innerHTML="",n.appendChild(o)})},50);function setupTaskEventListeners(e,t,n){e.addEventListener("click",n=>{n.target.classList.contains("drag-handle")||(n.stopPropagation(),openEditTaskModal(t))}),e.addEventListener("dragstart",n=>{draggedElement=n.target,n.dataTransfer.setData("text/plain",t.id),n.dataTransfer.effectAllowed="move",setTimeout(()=>{n.target.classList.add("dragging")},0)}),e.addEventListener("dragend",e=>{e.target.classList.remove("dragging"),draggedElement=null,document.querySelectorAll(".drag-over-container").forEach(e=>e.classList.remove("drag-over-container")),document.querySelectorAll(".drag-over").forEach(e=>e.classList.remove("drag-over"))}),e.addEventListener("dragover",t=>{if(draggedElement&&draggedElement!==e&&draggedElement.dataset.taskDay===e.dataset.taskDay){t.preventDefault();const n=e.parentElement,o=getDragAfterElement(n,t.clientY);null==o?n.appendChild(draggedElement):n.insertBefore(draggedElement,o)}})}function getDragAfterElement(e,t){const n=[...e.querySelectorAll(".task-item:not(.dragging)")];return n.reduce((e,n)=>{const o=n.getBoundingClientRect(),s=t-o.top-o.height/2;return s<0&&s>e.offset?{offset:s,element:n}:e},{offset:Number.NEGATIVE_INFINITY}).element}function initDayCardDropHandlers(){document.querySelectorAll(".day-card").forEach(e=>{e.addEventListener("dragover",e=>e.preventDefault()),e.addEventListener("dragenter",t=>{t.preventDefault();const n=e.querySelector(".task-container");draggedElement&&n&&draggedElement.parentElement!==n&&e.classList.add("drag-over")}),e.addEventListener("dragleave",t=>{e.classList.remove("drag-over")}),e.addEventListener("drop",t=>{if(t.preventDefault(),!draggedElement)return;e.classList.remove("drag-over");const n=e.closest(".day-card"),o=n.querySelector(".task-container"),s=draggedElement.dataset.taskId,a=draggedElement.dataset.taskDay,r=n.id;if(a!==r){const e=getDragAfterElement(o,t.clientY);e?o.insertBefore(draggedElement,e):o.appendChild(draggedElement),draggedElement.dataset.taskDay=r;const{start:i}=getWeekDateRange(currentDate),c=new Date(i);c.setDate(i.getDate()+dayMap[r]);const d=doc(db,"artifacts",appId,"public","data","tasks",s);setDoc(d,{day:r,date:formatDate(c),updatedAt:(new Date).toISOString()},{merge:!0}).catch(e=>{console.error("Lỗi khi di chuyển task:",e),setupWeekListener()});const l=document.getElementById(`tasks-${a}`);l&&reorderTasksInDay(a,l.querySelectorAll(".task-item")),reorderTasksInDay(r,o.querySelectorAll(".task-item"))}else reorderTasksInDay(r,o.querySelectorAll(".task-item"))})})}
  function setupWeekListener(){unsubscribeWeek&&unsubscribeWeek(),tasksCache.clear(),updateDateDisplay(),setLoading(!0);const{start:e,end:t}=getWeekDateRange(currentDate),n=formatDate(e);currentWeekId=n;const o=query(tasksCollectionRef,where("date",">=",formatDate(e)),where("date","<=",formatDate(t)));unsubscribeWeek=onSnapshot(o,e=>{if(currentWeekId!==n)return;document.getElementById("sync-dot").style.backgroundColor="green";const o={T2:[],T3:[],T4:[],T5:[],T6:[],T7:[],CN:[]};e.forEach(e=>{const t=e.data();t.day&&o[t.day]&&o[t.day].push({id:e.id,...t})}),renderTasks(o),setLoading(!1)},e=>{console.error("Week listener error:",e),document.getElementById("sync-dot").style.backgroundColor="red",setLoading(!1)})}function fetchAndRenderMonthEvents(e){unsubscribeMonth&&unsubscribeMonth(),setLoading(!0);const t=formatDate(e.start),n=formatDate(e.end),o=query(tasksCollectionRef,where("date",">=",t),where("date","<=",n));unsubscribeMonth=onSnapshot(o,e=>{const t=e.docs.map(e=>{const t={id:e.id,...e.data()};return{id:t.id,title:t.text||"(không tên)",start:t.date,allDay:!0,backgroundColor:t.color||"#e85499",borderColor:t.color||"#e85499",extendedProps:{day:t.day,updatedAt:t.updatedAt,order:t.order}}});calendarInstance&&(calendarInstance.removeAllEvents(),calendarInstance.addEventSource(t)),setLoading(!1),document.getElementById("sync-dot").style.backgroundColor="green"},e=>{console.error("Month listener error:",e),setLoading(!1),document.getElementById("sync-dot").style.backgroundColor="red"})}function initializeCalendar(){if(calendarInstance)return;const e=document.getElementById("calendar");calendarInstance=new FullCalendar.Calendar(e,{initialView:"dayGridMonth",locale:"vi",height:"auto",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,dayGridWeek"},datesSet:e=>{fetchAndRenderMonthEvents(e.view)},dateClick:e=>{openAddTaskModal(e.date)},eventClick:e=>{const t=e.event;openEditTaskModal({id:t.id,text:t.title,date:formatDate(new Date(t.start)),day:t.extendedProps?.day,color:t.backgroundColor,updatedAt:t.extendedProps?.updatedAt,order:t.extendedProps?.order})},dayMaxEventRows:!0}),calendarInstance.render()}async function copyLastWeekSchedule(){if(!confirm("Bạn có muốn sao chép toàn bộ lịch của tuần trước sang tuần này không?"))return;setLoading(!0);const e=new Date(currentDate);e.setDate(currentDate.getDate()-7);const{start:t,end:n}=getWeekDateRange(e),o=query(tasksCollectionRef,where("date",">=",formatDate(t)),where("date","<=",formatDate(n)));try{const e=await getDocs(o);if(e.empty)return void alert("Không tìm thấy môn học nào ở tuần trước để sao chép!");const{start:t}=getWeekDateRange(currentDate),s=writeBatch(db);e.forEach(e=>{const n=e.data(),o=dayMap[n.day];if(void 0!==o){const a=new Date(t);a.setDate(t.getDate()+o);const r={...n,date:formatDate(a),createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),order:n.order||1},i=doc(collection(db,"artifacts",appId,"public","data","tasks"));s.set(i,r)}}),await s.commit(),alert(`Đã sao chép ${e.size} môn học từ tuần trước!`)}catch(e){console.error("Lỗi khi commit batch:",e),alert("Đã xảy ra lỗi khi sao chép. Vui lòng thử lại!")}finally{setLoading(!1)}}
  window.closeModal = () => { document.getElementById('task-modal').classList.add('hidden'); currentEditingTask = null; };
  const debouncedWeekNavigation = debounce((direction) => { currentDate.setDate(currentDate.getDate() + (direction * 7)); setupWeekListener(); }, 100);
  document.getElementById('prev-week-btn').addEventListener('click', () => debouncedWeekNavigation(-1));
  document.getElementById('next-week-btn').addEventListener('click', () => debouncedWeekNavigation(1));
  document.getElementById('theme-toggle-btn').addEventListener('click', (e) => { e.stopPropagation(); updateTheme(currentTheme === 'light' ? 'dark' : 'light'); closeSidebar(); });
  const sidebar = document.getElementById('sidebar');
  const menuToggle = document.getElementById('menu-toggle');
  const sidebarClose = document.getElementById('sidebar-close');
  function openSidebar() { sidebar.classList.remove('translate-x-full'); }
  function closeSidebar() { sidebar.classList.add('translate-x-full'); }
  menuToggle.addEventListener('click', e => { e.stopPropagation(); openSidebar(); });
  sidebarClose.addEventListener('click', closeSidebar);
  document.addEventListener('click', (e) => { if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) { closeSidebar(); } });
  document.getElementById('copy-last-week-btn').addEventListener('click', async (e) => { e.stopPropagation(); await copyLastWeekSchedule(); closeSidebar(); });
  document.getElementById('copy-last-week-btn-inline').addEventListener('click', copyLastWeekSchedule);
  document.getElementById('delete-all-week-btn').addEventListener('click', async (e) => { e.stopPropagation(); await deleteAllWeekTasks(); closeSidebar(); });
  document.getElementById('toggle-view-btn').addEventListener('click', (e) => {
    e.stopPropagation(); calendarVisible = !calendarVisible;
    const weekView = document.getElementById('week-view');
    const monthView = document.getElementById('month-view');
    const weekNav = document.querySelector('.flex.items-center.p-2.gap-2');
    weekView.classList.toggle('hidden', calendarVisible);
    monthView.classList.toggle('hidden', !calendarVisible);
    weekNav.classList.toggle('hidden', calendarVisible);
    if (calendarVisible) { if (unsubscribeWeek) { unsubscribeWeek(); unsubscribeWeek = null; } initializeCalendar(); } else { if (unsubscribeMonth) { unsubscribeMonth(); unsubscribeMonth = null; } setupWeekListener(); }
    updateViewButton(); closeSidebar();
  });
  document.getElementById('task-modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });
  document.addEventListener('keydown', throttle((e) => {
    const modalHidden = document.getElementById('task-modal').classList.contains('hidden');
    if (e.key === 'Escape') { if (!modalHidden) closeModal(); else if (!sidebar.classList.contains('translate-x-full')) closeSidebar(); }
    if (e.key === 'Enter' && !modalHidden && !isLoading) { e.preventDefault(); window.saveTask(); }
    if (modalHidden && !calendarVisible && !isLoading && e.ctrlKey) {
      if (e.key === 'ArrowLeft') { e.preventDefault(); debouncedWeekNavigation(-1); }
      else if (e.key === 'ArrowRight') { e.preventDefault(); debouncedWeekNavigation(1); }
    }
  }, 100));
  
  function init() {
    try {
      updateTheme(currentTheme);
      updateViewButton();
      initDayCardDropHandlers();
      setupWeekListener();
      updateUIWithPermissions();
      console.log('App initialized successfully');
    } catch (error) {
      console.error('Initialization error:', error);
      document.getElementById('sync-dot').style.backgroundColor = 'red';
    }
  }

  init();

</script>

</body>
</html>
